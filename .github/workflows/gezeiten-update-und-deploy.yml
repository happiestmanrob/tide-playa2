name: "ğŸŒŠ Gezeiten â€“ Automatisch aktualisieren & verÃ¶ffentlichen"

on:
  workflow_dispatch:      # ğŸ”˜ Manuell starten mÃ¶glich
  schedule:
    - cron: "0 6 * * *"   # ğŸ•• Jeden Tag um 06:00 UTC

jobs:
  update-and-deploy:
    name: "Gezeiten aktualisieren und verÃ¶ffentlichen"
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© 1) Repository klonen
      - name: ğŸ“‚ Repository klonen
        uses: actions/checkout@v4

      # ğŸ 2) Python installieren (fÃ¼r BeautifulSoup-Scraper)
      - name: ğŸ Python installieren
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ğŸ“¦ 3) Python-Bibliotheken installieren
      - name: ğŸ“¦ Bibliotheken fÃ¼r Python installieren
        run: pip install requests beautifulsoup4

      # ğŸŒŠ 4) Python-Scraper ausfÃ¼hren
      - name: ğŸŒŠ Gezeiten abrufen (Python)
        id: py
        continue-on-error: true
        run: |
          echo "Starte Python-Scraper..."
          python skripts/update_tides.py

      # âš™ï¸ 5) Node.js installieren (fÃ¼r Fallback + Deployment)
      - name: âš™ï¸ Node.js installieren
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ğŸ“¦ 6) Node-AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Node-AbhÃ¤ngigkeiten installieren
        run: npm install

      # ğŸ” 7) Fallback: Puppeteer-Scraper (nur falls Python fehlschlug)
      - name: "ğŸ” Fallback: Puppeteer-Scraper (Node)"
        if: steps.py.outcome != 'success'
        run: |
          echo "Python-Scraper fehlgeschlagen â€“ starte Puppeteer-Fallback..."
          node skripts/fetch.js

      # ğŸ§ª 8) PrÃ¼fen, ob data/latest.json existiert
      - name: âœ… PrÃ¼fen, ob data/latest.json existiert
        run: |
          test -f data/latest.json || (echo "âŒ Datei data/latest.json fehlt!" && exit 1)

      # ğŸ—‚ï¸ 9) Frontend & Daten nach /public kopieren
      - name: ğŸ—‚ï¸ Frontend und Daten in /public kopieren
        run: |
          mkdir -p public/data
          cp -r frontend/* public/
          cp data/latest.json public/data/latest.json

      # ğŸ” 10) ÃœberprÃ¼fen der Ausgabe
      - name: ğŸ” Ausgabe verifizieren
        run: |
          echo "ğŸ“ Verzeichnisstruktur von /public:"
          ls -R public
          test -f public/index.html || (echo "âŒ public/index.html fehlt!" && exit 1)
          test -f public/data/latest.json || (echo "âŒ public/data/latest.json fehlt!" && exit 1)

      # ğŸš€ 11) Deployment auf GitHub Pages
      - name: ğŸš€ Auf GitHub Pages verÃ¶ffentlichen
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
