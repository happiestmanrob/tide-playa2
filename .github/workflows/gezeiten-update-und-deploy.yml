name: "ğŸŒŠ Gezeiten automatisch aktualisieren und verÃ¶ffentlichen"

on:
  workflow_dispatch:      # Manuell starten mÃ¶glich
  schedule:
    - cron: "0 6 * * *"   # Jeden Tag um 06:00 UTC

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest


    steps:
      # 1) Repo holen
      - name: ğŸ§© Repository klonen
        uses: actions/checkout@v4

      # 2) Python bereitstellen (fÃ¼r BeautifulSoup-Scraper)
      - name: ğŸ Python installieren
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Bibliotheken fÃ¼r Python installieren
        run: pip install requests beautifulsoup4

      # 3) Python-Scraper laufen lassen (nicht abbrechen, wenn er fehlschlÃ¤gt)
      - name: ğŸŒŠ Gezeiten abrufen (Python â€“ bevorzugt)
        id: py
        continue-on-error: true
        run: |
          echo "Starte Python-Scraperâ€¦"
          python skripts/update_tides.py || exit 1

      # 4) Node bereitstellen (Fallback fÃ¼r Puppeteer)
      - name: âš™ï¸ Node.js installieren
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Node-AbhÃ¤ngigkeiten installieren
        run: npm install

      # 5) Falls Python NICHT erfolgreich war ODER keine Datei entstanden ist:
      - name: ğŸ” Fallback: Puppeteer-Scraper (Node)
        if: steps.py.outcome != 'success'
        run: |
          echo "Python-Scraper fehlgeschlagen oder abgebrochen â€“ starte Puppeteer-Fallbackâ€¦"
          node skripts/fetch.js

      - name: ğŸ§ª PrÃ¼fen, ob data/latest.json existiert
        run: |
          test -f data/latest.json || (echo "âŒ data/latest.json wurde nicht erzeugt!" && exit 1)

      # 6) Frontend + Daten ins VerÃ¶ffentlichungsverzeichnis kopieren
      - name: ğŸ“‚ Frontend und Daten in /public kopieren
        run: |
          mkdir -p public/data
          cp -r frontend/* public/
          cp data/latest.json public/data/latest.json

      - name: âœ… Ausgabe verifizieren
        run: |
          echo "ğŸ” Verzeichnisstruktur:"
          ls -R public
          test -f public/index.html || (echo "âŒ public/index.html fehlt!" && exit 1)
          test -f public/data/latest.json || (echo "âŒ public/data/latest.json fehlt!" && exit 1)

      # 7) Deploy auf GitHub Pages
      - name: ğŸš€ Deploy auf GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
