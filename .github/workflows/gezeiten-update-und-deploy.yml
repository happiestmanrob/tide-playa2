name: "ğŸŒŠ Gezeiten â€“ Automatisch aktualisieren & verÃ¶ffentlichen"

on:
  workflow_dispatch:      # ğŸ”˜ Manuell starten mÃ¶glich
  schedule:
    - cron: "0 6 * * *"   # ğŸ•• Jeden Tag um 06:00 UTC

jobs:
  update-and-deploy:
    name: "Gezeiten aktualisieren und verÃ¶ffentlichen"
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© 1) Repository klonen
      - name: ğŸ“‚ Repository klonen
        uses: actions/checkout@v4

      # âš™ï¸ 2) Node.js installieren
      - name: âš™ï¸ Node.js installieren
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ğŸ“¦ 3) Node-AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Node-AbhÃ¤ngigkeiten installieren
        run: |
          echo "ğŸ“¦ Installiere npm-AbhÃ¤ngigkeiten..."
          npm install

      # ğŸŒŠ 4) Puppeteer-Scraper ausfÃ¼hren
      - name: ğŸŒŠ Gezeiten abrufen (Puppeteer)
        run: |
          echo "Starte Puppeteer-Scraper..."
          node skripts/fetch.js

      # âœ… 5) PrÃ¼fen, ob data/latest.json erzeugt wurde
      - name: âœ… PrÃ¼fen, ob data/latest.json existiert
        run: |
          if [ ! -f data/latest.json ]; then
            echo "âŒ Datei data/latest.json wurde nicht erzeugt!"
            exit 1
          else
            echo "âœ… Datei data/latest.json vorhanden."
          fi

      # ğŸ—‚ï¸ 6) Frontend & Daten nach /public kopieren
      - name: ğŸ—‚ï¸ Frontend und Daten in /public kopieren
        run: |
          echo "ğŸ“‚ Kopiere Frontend-Dateien und aktualisierte Gezeiten-Daten..."
          mkdir -p public/data
          cp -r frontend/* public/ || echo "âš ï¸ Kein frontend/-Ordner vorhanden"
          cp data/latest.json public/data/latest.json

      # ğŸ” 7) ÃœberprÃ¼fen der Ausgabe
      - name: ğŸ” Ausgabe verifizieren
        run: |
          echo "ğŸ“ Verzeichnisstruktur von /public:"
          ls -R public
          test -f public/index.html || (echo "âŒ public/index.html fehlt!" && exit 1)
          test -f public/data/latest.json || (echo "âŒ public/data/latest.json fehlt!" && exit 1)
          echo "âœ… Alle notwendigen Dateien vorhanden."

      # ğŸš€ 8) Deployment auf GitHub Pages
      - name: ğŸš€ Auf GitHub Pages verÃ¶ffentlichen
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
