<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shopping ‚Äì Rabatte & Ersparnis (v4.4 offline)</title>
<style>
:root{
 --bg:#faf8f6;--card:#fff;--ink:#1f2937;--muted:#6b7280;
 --accent:#f97316;--accent-600:#ea580c;--accent-100:#fff7ed;
 --ring:rgba(249,115,22,.35);--danger:#ef4444;--shadow:0 10px 25px rgba(0,0,0,.08)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1100px;margin:26px auto;padding:0 16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px}
.title{display:flex;align-items:center;gap:10px;width:100%}
.title label{font-weight:900;font-size:clamp(18px,3vw,28px)}
.title input{flex:1;min-width:220px;font:700 clamp(16px,2.8vw,24px) system-ui,-apple-system,Segoe UI,Roboto;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;background:#fff}
.title input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--accent);color:#fff;cursor:pointer;box-shadow:0 8px 16px rgba(249,115,22,.25)}
.btn:hover{background:var(--accent-600)}.btn.ghost{background:transparent;color:var(--accent-600);border:2px solid var(--accent-600)}
.btn.muted{background:#eee;color:#111}.btn.danger{background:var(--danger)}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.cell{grid-column:span 3}.w4{grid-column:span 4}.w2{grid-column:span 2}
@media(max-width:900px){.cell,.w4,.w2{grid-column:span 6}}
@media(max-width:580px){.cell,.w4,.w2{grid-column:1/-1}}
label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],input[type=number]{width:100%;padding:11px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:none;transition:.2s box-shadow,.2s border-color}
input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
table{width:100%;border-collapse:separate;border-spacing:0 6px;table-layout:fixed}
thead th{font-size:12px;color:#6b7280;text-align:left;padding:4px 8px}
thead th.r{text-align:right}
tbody td{background:#fff;border:1px solid #eee;padding:10px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
tbody td:first-child{border-right:0;border-radius:10px 0 0 10px}
tbody td:last-child{border-left:0;border-radius:0 10px 10px 0}
.r{text-align:right}
.group{font-weight:800;background:var(--accent);color:#fff;border:1px solid var(--accent-600);border-radius:10px;padding:8px 12px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
.group .label{font-size:14px}
.plus{width:32px;height:32px;border-radius:8px;border:2px solid #ffe3cc;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(234,88,12,.18)}
.icon{width:36px;height:36px;border-radius:10px;border:1px solid #eee;background:#fff;display:inline-flex;align-items:center;justify-content:center}
.icon:hover{transform:translateY(-1px)}
.summary{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.summary div{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:8px 12px}
.footer{text-align:center;color:#6b7280;margin:14px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:9999}
.toast.show{opacity:1;pointer-events:auto}
#printHdr{display:none}

/* Druckansicht / PDF */
@media print{
  body{font-size:10pt;background:#fff}
  .header,.grid,.summary,.footer,.btn,.icon,input,.plus{display:none!important}
  .container{max-width:100%;padding:0;margin:0}
  #printHdr{display:block;margin:0 22px 8px}
  #printHdr .brand{color:#ea580c;font-weight:900;text-align:center;margin:10px 0 2px 0;font-size:14pt}
  #printHdr .meta{font-size:10pt;margin:0 0 10px 0;text-align:center}
  table{border-collapse:collapse;margin:0 22px}
  thead th{background:#fff3e9;border-bottom:1px solid #ffd7ba}
  tbody td{border:1px solid #eee;padding:4px 6px;white-space:normal}
  .group{background:var(--accent);color:#fff;border:1px solid var(--accent-600);border-radius:8px;padding:4px 8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  @page{margin:12mm}
}
input.file-input{display:none}
</style>
</head>
<body>
<div class="container">
  <!-- Kopfbereich mit bearbeitbarem Titel -->
  <div class="header">
    <div class="title">
      <label for="titleInput">Shopping ‚Äì</label>
      <input id="titleInput" type="text" value="">
    </div>
    <button id="newListBtn" class="btn ghost">Neue Liste</button>
  </div>

  <!-- Eingabe -->
  <div class="card">
    <div class="grid">
      <div class="cell">
        <label class="small">Ort</label>
        <input id="loc" list="dlLoc" type="text"><datalist id="dlLoc"></datalist>
      </div>
      <div class="cell">
        <label class="small">Gesch√§ft</label>
        <input id="store" list="dlStore" type="text"><datalist id="dlStore"></datalist>
      </div>
      <div class="cell w4">
        <label class="small">Artikel</label>
        <input id="item" list="dlItem" type="text"><datalist id="dlItem"></datalist>
      </div>
      <div class="cell w2">
        <label class="small">Originalpreis (‚Ç¨)</label>
        <input id="orig" type="number" step="0.01">
      </div>
      <div class="cell w2">
        <label class="small">Kaufpreis (‚Ç¨)</label>
        <input id="paid" type="number" step="0.01">
      </div>
      <div class="cell w2" style="align-self:end">
        <button id="addTop" class="btn">+ Artikel hinzuf√ºgen</button>
      </div>
    </div>
  </div>

  <!-- Tabelle -->
  <div class="card">
    <table>
      <colgroup><col><col style="width:96px"><col style="width:96px"><col style="width:150px"></colgroup>
      <thead><tr><th>Artikel</th><th class="r">Originalpreis</th><th class="r">Kaufpreis</th><th class="r"></th></tr></thead>
      <tbody id="body"></tbody>
    </table>

    <!-- Summen + Aktionen -->
    <div class="summary">
      <div><b>Gesamtwert:</b> <span id="sumO">‚Äì</span></div>
      <div><b>Ausgegeben:</b> <span id="sumP">‚Äì</span></div>
      <div><b>Gespart:</b> <span id="sumS">‚Äì</span> <span id="sumPct">(‚Äì)</span></div>
      <div>
        <input id="file" type="file" class="file-input" accept=".json,application/json,.csv,text/csv">
        <button id="btnImp" class="btn muted">Importieren‚Ä¶</button>
        <button id="btnCsv" class="btn">Export CSV</button>
        <button id="btnJson" class="btn">Export JSON</button>
        <button id="btnPdf" class="btn">Export PDF</button>
        <button id="btnClr" class="btn danger">L√∂schen</button>
      </div>
    </div>
  </div>

  <div class="footer">Lokal gespeichert ‚Äì Version 4.4</div>
</div>

<!-- Kopfbereich nur f√ºr PDF -->
<div id="printHdr">
  <div class="brand" id="pdfTitle"></div>
  <div class="meta" id="pdfMeta"></div>
</div>
<div id="toast" class="toast"></div>

<!-- Datalists -->
<datalist id="dlItem"></datalist>
<datalist id="dlStore"></datalist>
<datalist id="dlLoc"></datalist>

<script>
(function(){
'use strict';
const $=id=>document.getElementById(id);
const fmt=new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'});
const numFmt=new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const euro=n=>fmt.format(+n||0);
const euroToNum=v=>parseFloat((''+v).replace(/[^0-9,.-]/g,'').replace(',','.'))||0;
const toast=m=>{const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400)};

// Datum / Titel
const pad=n=>(''+n).padStart(2,'0');
const now=new Date();
const defaultTitle=pad(now.getDate())+'.'+pad(now.getMonth()+1)+'.'+now.getFullYear();
$('titleInput').value=(localStorage.getItem('einkaufsliste_title')||defaultTitle);
$('titleInput').addEventListener('input',()=>localStorage.setItem('einkaufsliste_title',$('titleInput').value.trim()));

// Daten & Ordnungen (Eingabereihenfolge)
let items=load('einkaufsliste',[]);
let order=load('einkaufsliste_order',{locations:[],storesByLoc:{}});

// Vorschl√§ge
let sugg=load('einkaufsliste_suggest',{items:[],stores:[],locations:[]});
['Hose','Kurze Hose','Hemd','T-Shirt','Pullover','Socken','Boxershorts','Schlafanzug','Anzug','Sonnenbrille','Cappy','Bermudashorts','CK-Hemd','BH','Hemd Musselin','Hemd Rosa','Jacke'].forEach(v=>addSug('items',v));
['Jack&Jones','Lefties','El Corte Ingl√©s','Cortefiel','Springfield','Fifty','H&M'].forEach(v=>addSug('stores',v));
['Las Terrazas','Vecindario','Atlantico','Balos','Alcampo','LPA'].forEach(v=>addSug('locations',v));
save('einkaufsliste_suggest',sugg);
renderDatalists();

function load(k,f){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch(e){return f}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function addSug(kind,val){val=(val||'').trim(); if(!val) return; const a=sugg[kind]; if(a.every(x=>x.toLowerCase()!==val.toLowerCase())) a.push(val)}
function renderDatalists(){
  $('dlItem').innerHTML=sugg.items.map(v=>`<option value="${escapeHtml(v)}">`).join('');
  $('dlStore').innerHTML=sugg.stores.map(v=>`<option value="${escapeHtml(v)}">`).join('');
  $('dlLoc').innerHTML=sugg.locations.map(v=>`<option value="${escapeHtml(v)}">`).join('');
}
function escapeHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}

function ensureOrder(loc,store){
  loc=loc||''; store=store||'';
  if(!order.locations.includes(loc)) order.locations.push(loc);
  if(!order.storesByLoc[loc]) order.storesByLoc[loc]=[];
  if(!order.storesByLoc[loc].includes(store)) order.storesByLoc[loc].push(store);
  save('einkaufsliste_order',order);
}

// Render
const tbody=$('body');
function render(){
  tbody.innerHTML='';
  const o=items.reduce((a,b)=>a+euroToNum(b.original),0);
  const p=items.reduce((a,b)=>a+euroToNum(b.paid),0);
  const s=Math.max(o-p,0), pc=o?100*s/o:0;
  $('sumO').textContent=euro(o); $('sumP').textContent=euro(p);
  $('sumS').textContent=euro(s); $('sumPct').textContent='('+numFmt.format(pc)+' %)';

  order.locations.forEach(loc=>{
    (order.storesByLoc[loc]||[]).forEach(store=>{
      const group=items.filter(x=>(x.location||'')===loc && (x.store||'')===store);
      if(!group.length) return;
      const trH=document.createElement('tr'), tdH=document.createElement('td'); tdH.colSpan=4;
      tdH.innerHTML=`<div class="group"><div class="label">${[loc,store].filter(Boolean).join(' ‚Äì ')}</div><button class="plus" data-add="${loc}|${store}">+</button></div>`;
      trH.appendChild(tdH); tbody.appendChild(trH);

      group.forEach(it=>{
        const tr=document.createElement('tr'); tr.dataset.id=it.id; tr.dataset.group=loc+'|'+store;
        tr.innerHTML=`<td>${escapeHtml(it.item||'')}</td>
          <td class="r">${euro(euroToNum(it.original))}</td>
          <td class="r">${euro(euroToNum(it.paid))}</td>
          <td class="r"><button class="icon" data-edit="${it.id}">‚úèÔ∏è</button></td>`;
        tbody.appendChild(tr);
      });
    });
  });
}

// Plus / Edit Inline
tbody.addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return;

  // Neues Item in Gruppe
  if(b.hasAttribute('data-add')){
    const [loc,store]=b.getAttribute('data-add').split('|');
    const row=document.createElement('tr'); row.dataset.group=loc+'|'+store;
    row.innerHTML=`<td><input type="text" placeholder="Artikel" style="width:100%"></td>
      <td class="r"><input type="number" step="0.01" style="width:90px"></td>
      <td class="r"><input type="number" step="0.01" style="width:90px"></td>
      <td class="r"><button class="icon" data-save-new>üíæ</button> <button class="icon" data-cancel-new>‚ùå</button></td>`;
    // hinter letzte Zeile derselben Gruppe
    let last=null; tbody.querySelectorAll(`tr[data-group="${loc}|${store}"]`).forEach(tr=>last=tr);
    (last?last:tbody).after ? (last?last:tbody).after(row) : tbody.appendChild(row);

    row.querySelector('[data-save-new]').addEventListener('click',()=>{
      const ins=row.querySelectorAll('input');
      const rec={id:uid(),location:loc,store:store,item:(ins[0].value||'').trim(),original:euroToNum(ins[1].value),paid:euroToNum(ins[2].value)};
      items.push(rec); ensureOrder(loc,store);
      addSug('items',rec.item); addSug('stores',store); addSug('locations',loc);
      save('einkaufsliste',items); save('einkaufsliste_suggest',sugg);
      renderDatalists(); render(); toast('Neuer Artikel gespeichert'); setTimeout(()=>$('item').focus(),0);
    });
    row.querySelector('[data-cancel-new]').addEventListener('click',()=>{row.remove(); setTimeout(()=>$('item').focus(),0);});
    return;
  }

  // Edit
  if(b.hasAttribute('data-edit')){
    const id=b.getAttribute('data-edit');
    const row=tbody.querySelector(`tr[data-id="${id}"]`); if(!row) return;
    const rec=items.find(x=>x.id===id);
    row.innerHTML=`<td><input type="text" value="${escapeHtml(rec.item||'')}" style="width:100%"></td>
      <td class="r"><input type="number" step="0.01" value="${euroToNum(rec.original).toFixed(2)}" style="width:90px"></td>
      <td class="r"><input type="number" step="0.01" value="${euroToNum(rec.paid).toFixed(2)}" style="width:90px"></td>
      <td class="r"><button class="icon" data-save="${id}">üíæ</button> <button class="icon" data-del="${id}">üóëÔ∏è</button> <button class="icon" data-cancel="${id}">‚ùå</button></td>`;

    row.querySelector(`[data-save="${id}"]`).addEventListener('click',()=>{
      const ins=row.querySelectorAll('input'); rec.item=(ins[0].value||'').trim(); rec.original=euroToNum(ins[1].value); rec.paid=euroToNum(ins[2].value);
      addSug('items',rec.item); save('einkaufsliste',items); renderDatalists(); render(); toast('√Ñnderungen gespeichert'); setTimeout(()=>$('item').focus(),0);
    });
    row.querySelector(`[data-cancel="${id}"]`).addEventListener('click',()=>{ render(); setTimeout(()=>$('item').focus(),0); });
    row.querySelector(`[data-del="${id}"]`).addEventListener('click',()=>{ if(!confirm('Eintrag l√∂schen?'))return; items=items.filter(x=>x.id!==id); save('einkaufsliste',items); render(); toast('Eintrag gel√∂scht'); setTimeout(()=>$('item').focus(),0); });
  }
});

// Hinzuf√ºgen oben
$('addTop').addEventListener('click',()=>{
  const loc=$('loc').value.trim(), store=$('store').value.trim(), item=$('item').value.trim(), o=euroToNum($('orig').value), p=euroToNum($('paid').value);
  if(!item){alert('Bitte Artikel eingeben.');return}
  const rec={id:uid(),location:loc,store:store,item:item,original:o,paid:p};
  items.push(rec); ensureOrder(loc,store);
  addSug('locations',loc); addSug('stores',store); addSug('items',item);
  save('einkaufsliste',items); save('einkaufsliste_order',order); save('einkaufsliste_suggest',sugg);
  $('item').value=''; $('orig').value=''; $('paid').value='';
  renderDatalists(); render(); toast('Artikel hinzugef√ºgt'); $('item').focus();
});
['loc','store','item','orig','paid'].forEach(id=>$(id).addEventListener('keyup',e=>{if(e.key==='Enter')$('addTop').click()}));

// Neue Liste / L√∂schen
$('newListBtn').addEventListener('click',()=>{ if(items.length && !confirm('Neue Liste starten?')) return; items=[]; order={locations:[],storesByLoc:{}}; save('einkaufsliste',items); save('einkaufsliste_order',order); render(); toast('Neue Liste gestartet'); $('item').focus(); });
$('btnClr').addEventListener('click',()=>{ if(!items.length) return; if(confirm('Liste komplett l√∂schen?')){ items=[]; order={locations:[],storesByLoc:{}}; save('einkaufsliste',items); save('einkaufsliste_order',order); render(); toast('Liste gel√∂scht'); $('item').focus(); }});

// Datei-Download (mit Fallback)
function downloadFile(filename, content, mime){
  try{
    const blob=new Blob([content],{type:mime});
    const a=document.createElement('a');
    if('download' in a){ a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); }
    else{ window.open('data:'+mime+';base64,'+btoa(unescape(encodeURIComponent(content))),'_blank'); }
  }catch(e){ window.open('data:'+mime+';base64,'+btoa(unescape(encodeURIComponent(content))),'_blank'); }
}

// Export CSV/JSON
$('btnCsv').addEventListener('click',()=>{
  if(!items.length){alert('Keine Daten.');return}
  const sep=';';
  const rows=items.map(x=>[x.location||'',x.store||'',x.item||'',(+euroToNum(x.original)).toFixed(2),(+euroToNum(x.paid)).toFixed(2)]);
  const csv=['Ort;Gesch√§ft;Artikel;Originalpreis;Kaufpreis'].concat(rows.map(r=>r.join(sep))).join('\n');
  downloadFile('Shopping_'+$('titleInput').value.trim()+'.csv','\ufeff'+csv,'text/csv;charset=utf-8');
});
$('btnJson').addEventListener('click',()=>{
  const payload=JSON.stringify({version:44,items:items,order:order,suggest:sugg,title:$('titleInput').value.trim()},null,2);
  downloadFile('Shopping_'+$('titleInput').value.trim()+'.json',payload,'application/json;charset=utf-8');
});

// PDF-Export ‚Äì mobil-fest (ohne Timeout)
$('btnPdf').addEventListener('click',()=>{
  const o=items.reduce((a,b)=>a+euroToNum(b.original),0),
        p=items.reduce((a,b)=>a+euroToNum(b.paid),0),
        s=Math.max(o-p,0), pc=o?100*s/o:0;
  $('pdfTitle').textContent='Shopping ‚Äì '+$('titleInput').value.trim();
  $('pdfMeta').textContent='Gesamtwert: '+euro(o)+' | Ausgegeben: '+euro(p)+' | Gespart: '+euro(s)+' ('+numFmt.format(pc)+' %)';
  window.print();
});

// Initial-Ordnung ableiten (falls leer)
if(!order.locations.length && items.length){ order={locations:[],storesByLoc:{}}; items.forEach(r=>ensureOrder(r.location||'',r.store||'')) }

render();
$('item').focus();
})();
</script>
</body>
</html>
