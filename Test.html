<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shopping ‚Äì Rabatte & Ersparnis (v4.10)</title>
<style>
:root{
  --bg:#faf8f6;--card:#fff;--ink:#1f2937;--muted:#6b7280;
  --accent:#f97316;--accent-600:#ea580c;--accent-100:#fff7ed;
  --ring:rgba(249,115,22,.35);--danger:#ef4444;--shadow:0 10px 25px rgba(0,0,0,.08)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1100px;margin:26px auto;padding:0 16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px}
.title{font-weight:800;font-size:clamp(18px,3vw,28px);display:flex;gap:8px;align-items:center}
.pill{background:var(--accent-100);color:var(--accent-600);padding:6px 10px;border-radius:999px;font-weight:600}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.cell{grid-column:span 3}.w4{grid-column:span 4}.w2{grid-column:span 2}
@media(max-width:900px){.cell,.w4,.w2{grid-column:span 6}}
@media(max-width:580px){.cell,.w4,.w2{grid-column:1/-1}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],input[type=number]{width:100%;padding:11px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:none;transition:.2s box-shadow,.2s border-color}
input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;background:var(--accent);color:#fff;cursor:pointer;box-shadow:0 8px 16px rgba(249,115,22,.25)}
.btn:hover{background:var(--accent-600)}.btn.ghost{background:transparent;color:var(--accent-600);border:2px solid var(--accent-600)}
.btn.muted{background:#eee;color:#111}.btn.danger{background:var(--danger)}
.icon{width:36px;height:36px;border-radius:10px;border:1px solid #eee;background:#fff;display:inline-flex;align-items:center;justify-content:center;transition:.15s transform}
.icon:hover{transform:translateY(-1px)}
table{width:100%;border-collapse:separate;border-spacing:0 6px;table-layout:fixed}
thead th{font-size:12px;color:#6b7280;text-align:left;padding:4px 8px}
thead th.r{text-align:right}
tbody td{background:#fff;border:1px solid #eee;padding:10px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
tbody td:first-child{border-right:0;border-radius:10px 0 0 10px}
tbody td:last-child{border-left:0;border-radius:0 10px 10px 0}
.r{text-align:right}
.group{font-weight:800;background:var(--accent);color:#fff;border:1px solid var(--accent-600);border-radius:10px;padding:6px 10px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
.group .label{font-size:14px}
.plus{width:32px;height:32px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(234,88,12,.18)}
.summary{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.summary div{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:8px 12px}
.footer{text-align:center;color:#6b7280;margin:14px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.25s;z-index:9999}
.toast.show{opacity:1;pointer-events:auto}
#printHdr{display:none}

/* Druckansicht */
@media print{
  body{font-size:10pt;background:#fff}
  .header,.grid,.summary,.footer,.btn,.icon,input,.plus{display:none!important}
  .container{max-width:100%;padding:0;margin:0}
  #printHdr{display:block;margin:0 22px 8px}
  #printHdr .brand{color:#ea580c;font-weight:900;text-align:center;margin:10px 0 2px 0;font-size:14pt}
  #printHdr .h1{color:#ea580c;font-weight:800;margin:4px 0 6px 0;font-size:12pt}
  #printHdr .meta{font-size:10pt;margin:0 0 10px 0}
  table{border-collapse:collapse;margin:0 22px}
  thead th{background:#fff3e9;border-bottom:1px solid #ffd7ba}
  tbody td{border:1px solid #eee;padding:4px 6px;white-space:normal}
  .group{background:var(--accent);color:#fff;border:1px solid var(--accent-600);border-radius:8px;padding:4px 8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  @page{margin:12mm}
}
body.printing thead th{background:#fff3e9}
input.file-input{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title" id="appTitle">Shopping <span class="pill">Rabatte & Ersparnis</span></div>
    <button id="newListBtn" class="btn ghost">Neue Liste</button>
  </div>

  <div class="card">
    <div class="grid">
      <div class="cell"><label>Ort</label><input id="loc" list="dlLoc" type="text"><datalist id="dlLoc"></datalist></div>
      <div class="cell"><label>Gesch√§ft</label><input id="store" list="dlStore" type="text"><datalist id="dlStore"></datalist></div>
      <div class="cell w4"><label>Artikel</label><input id="item" list="dlItem" type="text"><datalist id="dlItem"></datalist></div>
      <div class="cell w2"><label>Originalpreis (‚Ç¨)</label><input id="orig" type="number" step="0.01"></div>
      <div class="cell w2"><label>Kaufpreis (‚Ç¨)</label><input id="paid" type="number" step="0.01"></div>
      <div class="cell w2" style="align-self:end"><button id="addTop" class="btn">+ Artikel hinzuf√ºgen</button></div>
    </div>
  </div>

  <div class="card">
    <table>
      <colgroup>
        <col>
        <col style="width:96px">
        <col style="width:96px">
        <col style="width:140px">
      </colgroup>
      <thead>
        <tr><th>Artikel</th><th class="r">Originalpreis</th><th class="r">Kaufpreis</th><th class="r"></th></tr>
      </thead>
      <tbody id="body"></tbody>
    </table>

    <div class="summary">
      <div><b>Gesamtwert:</b> <span id="sumO">‚Äì</span></div>
      <div><b>Ausgegeben:</b> <span id="sumP">‚Äì</span></div>
      <div><b>Gespart:</b> <span id="sumS">‚Äì</span> <span id="sumPct">(‚Äì)</span></div>
      <div>
        <input id="file" type="file" class="file-input" accept=".json,application/json,.csv,text/csv">
        <button id="btnImp" class="btn muted">Importieren‚Ä¶</button>
        <button id="btnCsv" class="btn">Export CSV</button>
        <button id="btnJson" class="btn">Export JSON</button>
        <button id="btnPdf" class="btn">Export PDF</button>
        <button id="btnClr" class="btn danger">L√∂schen</button>
      </div>
    </div>
  </div>

  <div class="footer">Lokal gespeichert ‚Äì Version 4.10</div>
</div>

<!-- Kopfbereich f√ºr die Druck-/PDF-Ansicht -->
<div id="printHdr">
  <div class="brand">Shopping √úbersicht ‚Äì Dein Sparergebnis</div>
  <div class="h1" id="pdfTitle"></div>
  <div class="meta" id="pdfMeta"></div>
</div>

<div id="toast" class="toast"></div>

<datalist id="dlItem"></datalist>
<datalist id="dlStore"></datalist>
<datalist id="dlLoc"></datalist>

<script>
(function(){
'use strict';
var de='de-DE',fmt=new Intl.NumberFormat(de,{style:'currency',currency:'EUR'});
var num=new Intl.NumberFormat(de,{minimumFractionDigits:2,maximumFractionDigits:2});
var $=function(id){return document.getElementById(id)};
function euroToNum(v){return parseFloat((''+v).replace(/[^0-9,.-]/g,'').replace(',','.'))||0}
function euro(n){return fmt.format(n||0)} function pct(n){return num.format(n)+' %'}
function toast(m){var t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},1500)}
function load(k,f){try{var r=localStorage.getItem(k);return r?JSON.parse(r):f}catch(e){return f}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function pad(n){return (''+n).padStart(2,'0')}
var now=new Date(),todayDE=pad(now.getDate())+'.'+pad(now.getMonth()+1)+'.'+now.getFullYear(),todayISO=now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate());
$('appTitle').innerHTML='Shopping ‚Äì '+todayDE+'<span class="pill">Rabatte & Ersparnis</span>';

// Daten
var items=load('einkaufsliste',[]).map(function(x){x.id=x.id||uid();return x});
var order=load('einkaufsliste_order',{locations:[],storesByLoc:{}}); // chronologische Reihenfolge
var sugg=load('einkaufsliste_suggest',{items:[],stores:[],locations:[]});

// Vorschl√§ge initial
['Hose','Kurze Hose','Hemd','T-Shirt','Pullover','Socken','Boxershorts','Schlafanzug','Anzug','Sonnenbrille','Cappy','Bermudashorts','CK-Hemd','BH','Hemd Musselin','Hemd Rosa','Jacke'].forEach(addSug.bind(null,'items'));
['Jack&Jones','Lefties','El Corte Ingl√©s','Cortefiel','Springfield','Fifty'].forEach(addSug.bind(null,'stores'));
['Las Terrazas','Atlantico','Balos','Alcampo','LPA','Vecindario'].forEach(addSug.bind(null,'locations'));
save('einkaufsliste_suggest',sugg);

function addSug(kind,val){
  val=(val||'').trim(); if(!val) return;
  var arr=sugg[kind];
  if(arr.every(function(x){return x.toLowerCase()!==val.toLowerCase()})) arr.push(val)
}
function renderDatalists(){
  $('dlItem').innerHTML=sugg.items.map(opt).join('');
  $('dlStore').innerHTML=sugg.stores.map(opt).join('');
  $('dlLoc').innerHTML=sugg.locations.map(opt).join('');
}
function opt(v){return '<option value="'+v.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'">'}
renderDatalists();

function ensureOrder(loc,store){
  loc=loc||''; store=store||'';
  if(order.locations.indexOf(loc)===-1) order.locations.push(loc);
  if(!order.storesByLoc[loc]) order.storesByLoc[loc]=[];
  if(order.storesByLoc[loc].indexOf(store)===-1) order.storesByLoc[loc].push(store);
  save('einkaufsliste_order',order);
}

// Render
var tbody=$('body');
function render(){
  tbody.innerHTML='';
  var o=items.reduce(function(a,b){return a+euroToNum(b.original)},0),
      p=items.reduce(function(a,b){return a+euroToNum(b.paid)},0),
      s=Math.max(o-p,0), pc=o?100*s/o:0;
  $('sumO').textContent=euro(o); $('sumP').textContent=euro(p);
  $('sumS').textContent=euro(s); $('sumPct').textContent='('+pct(pc)+')';

  order.locations.forEach(function(loc){
    (order.storesByLoc[loc]||[]).forEach(function(store){
      var groupItems=items.filter(function(x){return (x.location||'')===loc && (x.store||'')===store});
      if(!groupItems.length) return;
      var trH=document.createElement('tr'), tdH=document.createElement('td'); tdH.colSpan=4;
      // √úberschrift: Ort ‚Äì Gesch√§ft
      tdH.innerHTML='<div class="group"><div class="label">'+[loc,store].filter(Boolean).join(' ‚Äì ')+'</div><button class="plus" data-add="'+loc+'|'+store+'">+</button></div>';
      trH.appendChild(tdH); tbody.appendChild(trH);
      groupItems.forEach(function(it){
        var tr=document.createElement('tr'); tr.setAttribute('data-id',it.id); tr.setAttribute('data-group',loc+'|'+store);
        tr.innerHTML='<td>'+ (it.item||'') +'</td><td class="r">'+euro(euroToNum(it.original))+'</td><td class="r">'+euro(euroToNum(it.paid))+'</td><td class="r"><button class="icon" data-edit="'+it.id+'">‚úèÔ∏è</button></td>';
        tbody.appendChild(tr);
      });
    });
  });
}

// Tabelle interaktiv
tbody.addEventListener('click',function(e){
  var b=e.target.closest('button'); if(!b) return;

  if(b.hasAttribute('data-add')){
    var g=b.getAttribute('data-add'), parts=g.split('|'); var loc=parts[0]||'', store=parts[1]||'';
    var row=document.createElement('tr'); row.setAttribute('data-group',g);
    row.innerHTML='<td><input type="text" placeholder="Artikel" style="width:100%"></td><td class="r"><input type="number" step="0.01" style="width:90px"></td><td class="r"><input type="number" step="0.01" style="width:90px"></td><td class="r"><button class="icon" data-save-new="1">üíæ</button> <button class="icon" data-cancel-new="1">‚ùå</button></td>';
    var last=null; Array.prototype.forEach.call(tbody.querySelectorAll('tr[data-group="'+g+'"]'),function(tr){last=tr});
    if(last) last.after(row); else tbody.appendChild(row);

    row.querySelector('[data-save-new]').addEventListener('click',function(){
      var ins=row.querySelectorAll('input');
      var rec={id:uid(),location:loc,store:store,item:(ins[0].value||'').trim(),original:euroToNum(ins[1].value),paid:euroToNum(ins[2].value)};
      items.push(rec); ensureOrder(loc,store);
      addSug('items',rec.item); addSug('stores',store); addSug('locations',loc);
      save('einkaufsliste',items); save('einkaufsliste_suggest',sugg);
      renderDatalists(); render(); toast('Neuer Artikel gespeichert');
      setTimeout(function(){ $('item').focus() }, 0);
    });
    row.querySelector('[data-cancel-new]').addEventListener('click',function(){ row.remove(); setTimeout(function(){ $('item').focus() }, 0); });
    return;
  }

  if(b.hasAttribute('data-edit')){
    var id=b.getAttribute('data-edit'), row=tbody.querySelector('tr[data-id="'+id+'"]'); if(!row) return;
    var rec=items.find(function(x){return x.id===id});
    row.innerHTML='<td><input type="text" value="'+(rec.item||'')+'" style="width:100%"></td><td class="r"><input type="number" step="0.01" value="'+euroToNum(rec.original).toFixed(2)+'" style="width:90px"></td><td class="r"><input type="number" step="0.01" value="'+euroToNum(rec.paid).toFixed(2)+'" style="width:90px"></td><td class="r"><button class="icon" data-save="'+id+'">üíæ</button> <button class="icon" data-del="'+id+'">üóëÔ∏è</button> <button class="icon" data-cancel="'+id+'">‚ùå</button></td>';
    row.querySelector('[data-save="'+id+'"]').addEventListener('click',function(){ var ins=row.querySelectorAll('input'); rec.item=(ins[0].value||'').trim(); rec.original=euroToNum(ins[1].value); rec.paid=euroToNum(ins[2].value); addSug('items',rec.item); save('einkaufsliste',items); renderDatalists(); render(); toast('√Ñnderungen gespeichert'); setTimeout(function(){ $('item').focus() }, 0); });
    row.querySelector('[data-cancel="'+id+'"]').addEventListener('click',function(){ render(); setTimeout(function(){ $('item').focus() }, 0); });
    row.querySelector('[data-del="'+id+'"]').addEventListener('click',function(){ if(!confirm('Eintrag l√∂schen?'))return; items=items.filter(function(x){return x.id!==id}); save('einkaufsliste',items); render(); toast('Eintrag gel√∂scht'); setTimeout(function(){ $('item').focus() }, 0); });
  }
});

// Hinzuf√ºgen oben
$('addTop').addEventListener('click',function(){
  var loc=$('loc').value.trim(), store=$('store').value.trim(), item=$('item').value.trim(), o=euroToNum($('orig').value), p=euroToNum($('paid').value);
  if(!loc && !store){ alert('Bitte mindestens Ort und Gesch√§ft angeben.'); return }
  var rec={id:uid(),location:loc,store:store,item:item,original:o,paid:p};
  items.push(rec);
  ensureOrder(loc,store); addSug('locations',loc); addSug('stores',store); addSug('items',item);
  save('einkaufsliste',items); save('einkaufsliste_order',order); save('einkaufsliste_suggest',sugg);
  $('item').value=''; $('orig').value=''; $('paid').value='';
  renderDatalists(); render(); toast('Artikel hinzugef√ºgt');
  $('item').focus();
});
['loc','store','item','orig','paid'].forEach(function(id){ $(id).addEventListener('keyup',function(e){ if(e.key==='Enter') $('addTop').click() }) });

// Neue Liste / L√∂schen
$('newListBtn').addEventListener('click',function(){ if(items.length && !confirm('Neue Liste starten?')) return; items=[]; order={locations:[],storesByLoc:{}}; save('einkaufsliste',items); save('einkaufsliste_order',order); render(); toast('Neue Liste gestartet'); $('item').focus(); });
$('btnClr').addEventListener('click',function(){ if(!items.length) return; if(confirm('Liste komplett l√∂schen?')){ items=[]; order={locations:[],storesByLoc:{}}; save('einkaufsliste',items); save('einkaufsliste_order',order); render(); toast('Liste gel√∂scht'); $('item').focus(); }});

// Datei-Download (mit Fallback)
function downloadFile(filename, content, mime){
  try{
    var blob=new Blob([content],{type:mime});
    var a=document.createElement('a');
    if('download' in a){
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(function(){URL.revokeObjectURL(a.href)},1200);
    }else{
      window.open('data:'+mime+';base64,'+btoa(unescape(encodeURIComponent(content))),'_blank');
    }
  }catch(e){
    window.open('data:'+mime+';base64,'+btoa(unescape(encodeURIComponent(content))),'_blank');
  }
}

// Export CSV/JSON
$('btnCsv').addEventListener('click',function(){
  if(!items.length){alert('Keine Daten.');return}
  var sep=';';
  var rows=items.map(function(x){return [x.store,x.location||'',x.item,(+euroToNum(x.original)).toFixed(2),(+euroToNum(x.paid)).toFixed(2)]});
  var csv=['Gesch√§ft;Ort;Artikel;Originalpreis;Kaufpreis'].concat(rows.map(function(r){return r.join(sep)})).join('\n');
  downloadFile('Shopping '+todayISO+'.csv','\ufeff'+csv,'text/csv;charset=utf-8');
});
$('btnJson').addEventListener('click',function(){
  var payload=JSON.stringify({version:410,items:items,order:order,suggest:sugg},null,2);
  downloadFile('Shopping '+todayISO+'.json',payload,'application/json;charset=utf-8');
});

// PDF-Export: direkt aus Klick (mobil-kompatibel)
function doPrint(){
  var o=items.reduce(function(a,b){return a+euroToNum(b.original)},0),
      p=items.reduce(function(a,b){return a+euroToNum(b.paid)},0),
      s=Math.max(o-p,0), pc=o?100*s/o:0;

  // Druckkopf f√ºllen
  $('pdfTitle').textContent='Shopping ‚Äì '+todayDE;
  $('pdfMeta').textContent='Gesamtwert: '+euro(o)+' | Ausgegeben: '+euro(p)+' | Gespart: '+euro(s)+' ('+pct(pc)+')';

  // Dateiname √ºber document.title steuern (von vielen Browsern √ºbernommen)
  var oldTitle=document.title;
  document.title='Shopping ‚Äì '+todayISO;

  // Druckmodus sofort (KEIN Timeout -> f√ºr iOS/Android zuverl√§ssig)
  document.body.classList.add('printing');
  window.print();

  // Nach dem Druck zur√ºcksetzen
  document.title=oldTitle;
}
window.addEventListener('afterprint',function(){ document.body.classList.remove('printing') });
$('btnPdf').addEventListener('click',doPrint);

// Import (JSON/CSV) robust
$('btnImp').addEventListener('click',function(){ $('file').click() });
$('file').addEventListener('change',function(e){
  var f=e.target.files[0]; if(!f) return; var reader=new FileReader();
  reader.onload=function(){ try{
    var t=reader.result||''; var lower=(f.name||'').toLowerCase();
    if(lower.endsWith('.json')){
      var data=JSON.parse(t);
      var arr=Array.isArray(data)?data:(data&&data.items?data.items:[]);
      if(!Array.isArray(arr)) throw new Error('JSON: Feld "items" fehlt oder ist ung√ºltig.');
      items=arr.map(function(x){return {id:x.id||uid(),location:x.location||x.loc||'',store:x.store||'',item:x.item||x.article||'',original:euroToNum(x.original||x.originalprice||0),paid:euroToNum(x.paid||x.price||x.kauf||0)}});
      if(data.order && data.order.locations){order=data.order}else{order={locations:[],storesByLoc:{}}; items.forEach(function(r){ensureOrder(r.location,r.store)})}
      sugg={items:[],stores:[],locations:[]};
      items.forEach(function(r){ if(r.item) addSug('items',r.item); if(r.store) addSug('stores',r.store); if(r.location) addSug('locations',r.location) });
    }else{
      // CSV auch ohne Endung erkennen
      var looksCSV=lower.endsWith('.csv') || t.indexOf(';')>-1 || t.indexOf(',')>-1;
      if(!looksCSV) throw new Error('Nur .json oder .csv werden unterst√ºtzt.');
      var sep=t.indexOf(';')>-1?';':',';
      function parse(line){
        var out=[],q=false,val='';
        for(var i=0;i<line.length;i++){
          var c=line[i];
          if(c=='"'){q=!q;continue}
          if(c==sep && !q){out.push(val);val=''} else val+=c
        }
        out.push(val);
        return out.map(function(s){return s.replace(/^"|"$/g,'').replace(/""/g,'"')})
      }
      var lines=t.split(/\r?\n/).filter(function(l){return l.trim().length});
      if(!lines.length) throw new Error('CSV: Datei ist leer.');
      var header=parse(lines[0]).map(function(h){return h.toLowerCase()});
      var body=(/artikel|gesch√§ft|ort/.test(header.join(' '))?lines.slice(1):lines);
      items=[]; order={locations:[],storesByLoc:{}};
      body.forEach(function(line){
        var r=parse(line); if(!r.length) return;
        var S=header.indexOf('gesch√§ft'); var L=header.indexOf('ort'); var I=header.indexOf('artikel'); var O=header.indexOf('originalpreis'); var P=header.indexOf('kaufpreis');
        var store=(S>-1?r[S]:r[0])||''; var loc=(L>-1?r[L]:r[1])||''; var item=(I>-1?r[I]:r[2])||''; var op=(O>-1?r[O]:r[3])||0; var kp=(P>-1?r[P]:r[4])||0;
        var rec={id:uid(),location:loc,store:store,item:item,original:euroToNum(op),paid:euroToNum(kp)};
        items.push(rec); ensureOrder(loc,store);
      });
      sugg={items:[],stores:[],locations:[]};
      items.forEach(function(r){ if(r.item) addSug('items',r.item); if(r.store) addSug('stores',r.store); if(r.location) addSug('locations',r.location) });
    }
    save('einkaufsliste',items); save('einkaufsliste_order',order); save('einkaufsliste_suggest',sugg);
    renderDatalists(); render(); toast('Import erfolgreich: '+items.length+' Artikel');
  }catch(err){ alert('Import fehlgeschlagen: '+(err.message||err)); } finally { e.target.value='' } };
  reader.readAsText(f);
});

// Falls Reihenfolge noch nicht existiert: aus vorhandenen Items ableiten
if(!order.locations.length && items.length){ order={locations:[],storesByLoc:{}}; items.forEach(function(r){ensureOrder(r.location,r.store)}) }
render();
// Sofort-Fokus auf "Artikel"
$('item').focus();
})();
</script>
</body>
  </html> 
